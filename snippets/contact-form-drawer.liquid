{%- comment -%}
  Contact Form Drawer
  A slide-out contact form that can be triggered from product pages
  Allows users to contact about specific products while staying on the page
{%- endcomment -%}

<side-drawer class="contact-form-drawer" id="ContactFormDrawer" {%- render 'animation-attrs', attrs: 'data-cc-animate' -%}>
  <div class="side-drawer side-drawer--from-right">
    <div class="side-drawer__backdrop"></div>
    <div class="side-drawer__content">
      <div class="side-drawer__header">
        <h2 class="side-drawer__title">{{ 'contact.form.title' | t | default: 'Contact Us' }}</h2>
        <button class="side-drawer__close" type="button" aria-label="{{ 'accessibility.close' | t }}">
          {%- render 'icon', icon: 'cross', size: 'medium' -%}
        </button>
      </div>

      <div class="side-drawer__body">
        {% form 'contact', class: 'contact-form-drawer__form' %}
          {% if form.posted_successfully? %}
            <div class="contact-form-drawer__success">
              <p><strong>{{ 'contact.form.post_success' | t }}</strong></p>
              <button type="button" class="btn btn--secondary contact-form-drawer__close-success">
                {{ 'general.close' | t | default: 'Close' }}
              </button>
            </div>
          {% else %}
            {%- render 'form-errors', form: form -%}

            {%- comment -%} Product context hidden field {%- endcomment -%}
            {% if product %}
              <input type="hidden" name="contact[product]" value="{{ product.title | escape }} - {{ product.url | prepend: request.origin }}"/>
            {% endif %}

            <div class="contact-form-drawer__fields">
              <div class="contact-form-drawer__field">
                <label for="ContactFormName">{{ 'contact.form.name' | t }} <span class="required">*</span></label>
                <input type="text" id="ContactFormName" name="contact[{{ 'contact.form.name' | t | handle }}]" value="{% if form.name %}{{ form.name }}{% elsif customer %}{{ customer.name }}{% endif %}" required>
              </div>

              <div class="contact-form-drawer__field">
                <label for="ContactFormEmail">{{ 'contact.form.email' | t }} <span class="required">*</span></label>
                <input type="email" id="ContactFormEmail" name="contact[email]" value="{% if form.email %}{{ form.email }}{% elsif customer %}{{ customer.email }}{% endif %}" required>
              </div>

              <div class="contact-form-drawer__field">
                <label for="ContactFormPhone">{{ 'contact.form.phone' | t }}</label>
                <input type="tel" id="ContactFormPhone" name="contact[{{ 'contact.form.phone' | t | handle }}]" value="{% if form.phone %}{{ form.phone }}{% elsif customer %}{{ customer.phone }}{% endif %}">
              </div>

              <div class="contact-form-drawer__field">
                <label for="ContactFormMessage">{{ 'contact.form.message' | t }} <span class="required">*</span></label>
                <textarea id="ContactFormMessage" name="contact[body]" rows="6" required>{% if form.body %}{{ form.body }}{% endif %}</textarea>
              </div>
            </div>

            <div class="contact-form-drawer__actions">
              <button type="submit" class="btn btn--primary">
                {{ 'contact.form.send' | t }}
              </button>
              <button type="button" class="btn btn--secondary contact-form-drawer__cancel">
                {{ 'general.cancel' | t | default: 'Cancel' }}
              </button>
            </div>
          {% endif %}
        {% endform %}
      </div>
    </div>
  </div>
</side-drawer>

<style>
  .contact-form-drawer .side-drawer__content {
    width: 480px;
    max-width: 90vw;
  }

  .contact-form-drawer__success {
    text-align: center;
    padding: 2rem 0;
  }

  .contact-form-drawer__success p {
    margin-bottom: 1.5rem;
    color: var(--success-color, #28a745);
  }

  .contact-form-drawer__fields {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .contact-form-drawer__field {
    display: flex;
    flex-direction: column;
  }

  .contact-form-drawer__field label {
    margin-bottom: 0.5rem;
    font-weight: 500;
    font-size: var(--base-text-size);
  }

  .contact-form-drawer__field .required {
    color: var(--error-color, #dc3545);
  }

  .contact-form-drawer__field input,
  .contact-form-drawer__field textarea {
    padding: 0.75rem;
    border: 1px solid var(--input-border-color, #ccc);
    border-radius: var(--input-border-radius, 4px);
    font-size: var(--base-text-size);
    font-family: inherit;
    background: var(--input-bg-color, #fff);
    transition: border-color 0.2s ease;
  }

  .contact-form-drawer__field input:focus,
  .contact-form-drawer__field textarea:focus {
    outline: none;
    border-color: var(--accent-color, #007bff);
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
  }

  .contact-form-drawer__actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    flex-wrap: wrap;
  }

  .contact-form-drawer__actions .btn {
    flex: 1;
    min-width: 120px;
  }

  @media (max-width: 640px) {
    .contact-form-drawer .side-drawer__content {
      width: 100vw;
      height: 100vh;
    }

    .contact-form-drawer__actions {
      flex-direction: column;
    }

    .contact-form-drawer__actions .btn {
      flex: none;
    }
  }
</style>

<script>
  // Initialize contact form drawer functionality
  document.addEventListener('DOMContentLoaded', function() {
    const drawer = document.getElementById('ContactFormDrawer');
    if (!drawer) return;

    const closeButtons = drawer.querySelectorAll('.side-drawer__close, .contact-form-drawer__cancel, .contact-form-drawer__close-success');
    const backdrop = drawer.querySelector('.side-drawer__backdrop');

    // Close drawer function
    function closeDrawer() {
      drawer.classList.remove('is-open');
      document.body.classList.remove('drawer-open');
      removeTrapFocus();
    }

    // Close button events
    closeButtons.forEach(button => {
      button.addEventListener('click', closeDrawer);
    });

    // Backdrop click to close
    if (backdrop) {
      backdrop.addEventListener('click', closeDrawer);
    }

    // Escape key to close
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && drawer.classList.contains('is-open')) {
        closeDrawer();
      }
    });

    // Global function to open contact drawer
    window.openContactDrawer = function() {
      drawer.classList.add('is-open');
      document.body.classList.add('drawer-open');

      // Focus trap
      if (typeof trapFocus === 'function') {
        const firstInput = drawer.querySelector('input, textarea');
        trapFocus(drawer, firstInput);
      }
    };
  });
</script>