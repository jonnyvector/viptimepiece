{%- comment -%}
  Contact Form Drawer
  A slide-out contact form that can be triggered from product pages
  Allows users to contact about specific products while staying on the page
{%- endcomment -%}

<side-drawer class="contact-form-drawer" id="ContactFormDrawer" {%- render 'animation-attrs', attrs: 'data-cc-animate' -%}>
  <div class="side-drawer side-drawer--from-right">
    <div class="side-drawer__backdrop"></div>
    <div class="side-drawer__content">
      <div class="side-drawer__header">
        <h2 class="side-drawer__title">Contact Us</h2>
        <button class="side-drawer__close" type="button" aria-label="{{ 'accessibility.close' | t }}">
          {%- render 'icon', icon: 'cross', size: 'medium' -%}
        </button>
      </div>

      <div class="side-drawer__body">
        {% form 'contact', class: 'contact-form-drawer__form' %}
          {% if form.posted_successfully? %}
            <div class="contact-form-drawer__success">
              <p><strong>{{ 'contact.form.post_success' | t }}</strong></p>
              <button type="button" class="btn btn--secondary contact-form-drawer__close-success">
                Close
              </button>
            </div>
          {% else %}
            {%- render 'form-errors', form: form -%}

            {%- comment -%} Product context hidden field {%- endcomment -%}
            {% if product %}
              <input type="hidden" name="contact[product]" value="{{ product.title | escape }} - {{ product.url | prepend: request.origin }}"/>
            {% endif %}

            <div class="flexible-layout flexible-layout--form">
              <div class="column column--full">
                <label for="ContactFormName">{{ 'contact.form.name' | t | default: 'Name' }} <span class="required">*</span></label>
                <input type="text" id="ContactFormName" name="contact[name]" autocomplete="name" value="{% if form.name %}{{ form.name }}{% elsif customer %}{{ customer.name }}{% endif %}" required>
              </div>

              <div class="column column--full">
                <label for="ContactFormEmail">{{ 'contact.form.email' | t | default: 'Email' }} <span class="required">*</span></label>
                <input type="email" id="ContactFormEmail" name="contact[email]" class="email" autocomplete="email" spellcheck="false" autocapitalize="off" value="{% if form.email %}{{ form.email }}{% elsif customer %}{{ customer.email }}{% endif %}" required>
              </div>

              <div class="column column--full">
                <label for="ContactFormPhone">{{ 'contact.form.phone' | t | default: 'Phone' }}</label>
                <input type="tel" id="ContactFormPhone" name="contact[phone]" autocomplete="tel" value="{% if form.phone %}{{ form.phone }}{% elsif customer %}{{ customer.phone }}{% endif %}">
              </div>

              <div class="column column--full">
                <label for="ContactFormMessage">{{ 'contact.form.message' | t | default: 'Message' }} <span class="required">*</span></label>
                <textarea id="ContactFormMessage" name="contact[body]" required>{% if form.body %}{{ form.body }}{% endif %}</textarea>
              </div>
            </div>

            <div class="contact-form-drawer__actions">
              <button type="submit" class="btn btn--primary">
                {{ 'contact.form.send' | t }}
              </button>
              <button type="button" class="btn btn--secondary contact-form-drawer__cancel">
                Cancel
              </button>
            </div>
          {% endif %}
        {% endform %}
      </div>
    </div>
  </div>
</side-drawer>

<style>
  /* Hide drawer by default */
  .contact-form-drawer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .contact-form-drawer.is-open {
    pointer-events: auto;
    opacity: 1;
  }

  .contact-form-drawer .side-drawer {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .contact-form-drawer .side-drawer__backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .contact-form-drawer.is-open .side-drawer__backdrop {
    opacity: 1;
  }

  .contact-form-drawer .side-drawer__content {
    position: absolute;
    top: 0;
    right: 0;
    width: 480px;
    max-width: 90vw;
    height: 100%;
    background: rgb(var(--body-bg-color));
    color: rgb(var(--text-color));
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    transform: translateX(100%);
    transition: transform 0.3s ease;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .contact-form-drawer.is-open .side-drawer__content {
    transform: translateX(0);
  }

  .contact-form-drawer .side-drawer__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    border-bottom: 1px solid rgba(var(--text-color), 0.1);
    background: rgb(var(--body-bg-color));
  }

  .contact-form-drawer .side-drawer__title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: rgb(var(--text-color));
  }

  .contact-form-drawer .side-drawer__close {
    background: none;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    color: rgb(var(--text-color));
    transition: color 0.2s ease;
  }

  .contact-form-drawer .side-drawer__close:hover {
    color: rgb(var(--accent-color));
  }

  .contact-form-drawer .side-drawer__body {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
  }

  .contact-form-drawer__success {
    text-align: center;
    padding: 2rem 0;
  }

  .contact-form-drawer__success p {
    margin-bottom: 1.5rem;
    color: var(--success-color, #28a745);
  }

  /* Form uses theme's existing flexible-layout and input styles */
  .contact-form-drawer .required {
    color: rgb(var(--accent-color));
  }

  /* Ensure consistent input widths */
  .contact-form-drawer input,
  .contact-form-drawer textarea {
    width: 100%;
  }

  .contact-form-drawer .flexible-layout {
    gap: 1rem;
  }

  .contact-form-drawer__actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    flex-wrap: wrap;
  }

  .contact-form-drawer__actions .btn {
    flex: 1;
    min-width: 120px;
  }

  /* Prevent body scroll when drawer is open */
  body.drawer-open {
    overflow: hidden;
  }

  @media (max-width: 640px) {
    .contact-form-drawer .side-drawer__content {
      width: 100vw;
      height: 100vh;
    }

    .contact-form-drawer__actions {
      flex-direction: column;
    }

    .contact-form-drawer__actions .btn {
      flex: none;
    }
  }
</style>

<script>
  // Initialize contact form drawer functionality
  document.addEventListener('DOMContentLoaded', function() {
    const drawer = document.getElementById('ContactFormDrawer');
    if (!drawer) return;

    const closeButtons = drawer.querySelectorAll('.side-drawer__close, .contact-form-drawer__cancel, .contact-form-drawer__close-success');
    const backdrop = drawer.querySelector('.side-drawer__backdrop');

    // Close drawer function
    function closeDrawer() {
      drawer.classList.remove('is-open');
      document.body.classList.remove('drawer-open');
      removeTrapFocus();
    }

    // Close button events
    closeButtons.forEach(button => {
      button.addEventListener('click', closeDrawer);
    });

    // Backdrop click to close
    if (backdrop) {
      backdrop.addEventListener('click', closeDrawer);
    }

    // Escape key to close
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && drawer.classList.contains('is-open')) {
        closeDrawer();
      }
    });

    // Global function to open contact drawer
    window.openContactDrawer = function() {
      drawer.classList.add('is-open');
      document.body.classList.add('drawer-open');

      // Focus trap
      if (typeof trapFocus === 'function') {
        const firstInput = drawer.querySelector('input, textarea');
        trapFocus(drawer, firstInput);
      }
    };
  });
</script>